from crawler.task import BaseTask
from crawler.decorators.rpc.auth import authenticated
from crawler.rpc.tornadorpc import async
from crawler.fetcher import Fetcher
from crawler.decorators.tornado import gen
from settings.functions import testauth as auth


import re
import json

#stores = [107, 113, 119, 121, 1043, 1056, 1059, 1094, 2027, 2179, 2186, 2447, 2489, 2493, 2701, 3402, 3403, 3404, 3409, 3424, 3432, 5722, 5824]
stores = [107]
categories = [u'65794', u'131330', u'196866', u'262402', u'327938', u'393474', u'459010', u'524546', u'655618', u'514', u'770', u'1026', u'1282', u'69633', u'135169', u'200705', u'266241', u'331777', u'397313', u'462849', u'528385', u'593921', u'659457', u'67841', u'133377', u'198913', u'264449', u'329985', u'395521', u'461057', u'526593', u'592129', u'657665', u'723201', u'788737', u'985345', u'68353', u'133889', u'789249', u'199425', u'264961', u'330497', u'396033', u'461569', u'527105', u'658177', u'723713', u'69377', u'134913', u'65793', u'131329', u'196865', u'262401', u'327937', u'393473', u'459009', u'524545', u'197121', u'524801', u'131585', u'459265', u'262657', u'66049', u'328193', u'393729', u'396801', u'462337', u'527873', u'593409', u'658945', u'69121', u'134657', u'200193', u'265729', u'331265', u'393985', u'459521', u'66305', u'131841', u'197377', u'262913', u'328449', u'525057', u'66561', u'132097', u'197633', u'263169', u'328705', u'394241', u'459777', u'590849', u'66817', u'132353', u'197889', u'263425', u'328961', u'394497', u'460033', u'525569', u'591105', u'656641', u'722177', u'67073', u'132609', u'198145', u'263681', u'329217', u'460289', u'591361', u'656897', u'722433', u'787969', u'67329', u'132865', u'198401', u'263937', u'329473', u'395009', u'460545', u'67585', u'133121', u'198657', u'264193', u'329729', u'395265', u'460801', u'526337', u'591873', u'657409', u'68097', u'133633', u'199169', u'264705', u'330241', u'395777', u'461313', u'526849', u'68609', u'134145', u'199681', u'265217', u'330753', u'396289', u'65799', u'131335', u'66055', u'131591', u'197127', u'262663', u'328199', u'393735', u'66311', u'131847', u'197383', u'262919', u'393991', u'66567', u'263175', u'66823', u'132359', u'67079', u'132615', u'198151', u'329223', u'67335', u'132871', u'198407', u'263943', u'329479', u'395015', u'460551', u'526087', u'657159', u'67591', u'264199', u'329735', u'67847', u'133383', u'198919', u'264455', u'329991', u'461063', u'722181', u'66821', u'132357', u'197893', u'263429', u'394501', u'787717', u'328965', u'853253', u'460037', u'525573', u'591109', u'656645', u'393477', u'65797', u'131333', u'196869', u'262405', u'327941', u'590597', u'66309', u'131845', u'328453', u'393989', u'525061', u'66053', u'131589', u'197125', u'262661', u'393733', u'328197', u'66565', u'132101', u'197637', u'263173', u'328709', u'394245', u'67077', u'132613', u'198149', u'329221', u'67845', u'133381', u'198917', u'67589', u'133125', u'1797', u'262406', u'65798', u'131334', u'196870', u'327942', u'66054', u'131590', u'328198', u'197126', u'393734', u'262662', u'67078', u'132614', u'198150', u'263686', u'66310', u'131846', u'197382', u'262918', u'459526', u'328454', u'393990', u'66566', u'132102', u'197638', u'263174', u'328710', u'66822', u'132358', u'197894', u'263430', u'328966', u'394502', u'65795', u'131331', u'262403', u'1027', u'1283', u'1539', u'1795', u'655875', u'262659', u'459267', u'590339', u'66307', u'131843', u'65796', u'131332', u'196868', u'262404', u'327940', u'66052', u'197124', u'262660', u'66820', u'132356', u'197892', u'263428', u'328964', u'67076', u'132612', u'198148', u'263684', u'66308', u'131844', u'197380', u'262916', u'459524', u'328452', u'393988', u'66564', u'132100', u'197636']

class Walmart(BaseTask):

    @async
    def start(self):
        self.rpc_handler.result('Done')
        for store in stores:
            for category in categories:
                self.crawl_store(cid=category, sid=store)

    @gen.coroutine
    def crawl_store(self, cid, sid):
        BASE_URL = 'http://search.walmartmobile.cn:80/mobile/search?ps=20&categoryId={category_id}&keyword&storeId={store_id}'
        self.fetch(BASE_URL.format(category_id=cid, store_id=sid), args=(sid,), data_type='json', next=self._crawl_category, headers={'User-Agent': 'Mozilla/5.0 Windows'})

    @gen.coroutine
    def _crawl_category(self, data, sid):
        BASE_URL = 'http://mobile.walmartmobile.cn:80/MobileHD-0.0.1/items/detail/{upc}'
        items = [i['upc'] for i in data['data']['items']]
        for upc in items:
            self.fetch(BASE_URL.format(upc=upc), method='POST', data={'storeId': sid}, data_type='json', next=self._process, headers={'User-Agent': 'Mozilla/5.0 Windows'})

    def _process(self, data):
        self.save(data)
